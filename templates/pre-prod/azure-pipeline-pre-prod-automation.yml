parameters:
- name:     name
  type:     string
- name:     displayName
  type:     string
- name:     config
  type:     object
  default:  []
- name:     applicationBlueprint
  type:     string
- name:     blueprintVersion
  type:     string
- name:     modeElite
  type:     boolean
  default:  false
- name:     dependsOn
  type:     object
  default:  []

stages:
# -----------------------------------------------------------------------------------------------------
# PRE-PROD AUTOMATION STAGE (PPA)
# -----------------------------------------------------------------------------------------------------
- stage:         ${{parameters.name}}
  displayName:   ${{parameters.displayName}}
  dependsOn:
  - ${{ each stage in parameters.dependsOn }}:
    - ${{stage}}
  ${{ if ne(coalesce(parameters.config.nameVM, ''), '') }}: #910188 
    pool:
      name:      ${{coalesce(parameters.config.poolName, 'Azure Pipelines')}}
      vmImage:   ${{parameters.config.nameVM}}
  ${{ else }}:
    pool:
      name:      ${{parameters.config.namePool}}
  jobs:
  - job:          'PreProdAutomation'
    steps:
    # List all environment variables within this agent
    - bash: 'env | sort'
      displayName: Bootstrap Dump env variables
    
    # Inject the PPA template into the pipeline
    - template:   /templates/pre-prod/pre-prod-automation.yml@CeBlueprints
      parameters:
        applicationBlueprint: ${{parameters.applicationBlueprint}}
        blueprintVersion:     ${{parameters.blueprintVersion}}
        modeElite:            ${{parameters.modeElite}}