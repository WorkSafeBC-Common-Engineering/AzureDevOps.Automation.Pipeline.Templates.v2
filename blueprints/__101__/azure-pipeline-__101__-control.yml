parameters:
# Do NOT modify this baseline version. Use a higher version in the -start.yml template for newer features.
- name:     blueprintVersion
  type:     string
  default:  2.1.1
- name:     portfolioName
  type:     string
- name:     productName
  type:     string
- name:     publishFolder
  type:     string
- name:     applicationBlueprint
  type:     string
  default:  '__101__'
# Mode Elite - if true we tolerate no errors!
- name:     modeElite
  type:     boolean
  default:  true
# Bootstrap optionals
- name:     verbose
  type:     boolean
  default:  false
# CI Blueprint optionals
- name:     versionSpec
  type:     string
  default:  '5.11.x' # switch from 5.6.3 to 5.11.x as default
# CD Blueprint optionals
- name:     suppressCD
  type:     boolean
  default:  false

# VARIABLES
variables:
- ${{ if ne(parameters.suppressCD, true) }}:
  - template: /deploy/${{ lower(parameters.portfolioName) }}-${{ lower(parameters.productName) }}-config.yml@self

stages:

# --------------------------------------------------------------------------
# START OF PIPELINE
# --------------------------------------------------------------------------
- template: /blueprints/__101__/azure-pipeline-__101__-ci.yml@CeBlueprints
  parameters:
    blueprintVersion:     ${{parameters.blueprintVersion}}
    portfolioName:        ${{parameters.portfolioName}}
    productName:          ${{parameters.productName}}
    applicationBlueprint: ${{parameters.applicationBlueprint}}
    verbose:              ${{parameters.verbose}}
    modeElite:            ${{parameters.modeElite}}
    versionSpec:          ${{parameters.versionSpec}}
    jobPool:              ${{coalesce(variables.ciStagePool, 'Azure Pipelines')}}
    vmImage:              ${{coalesce(variables.ciStageVmImage, 'ubuntu-latest')}}

# --------------------------------------------------------------------------
# DEPLOYMENT
# 2021.10.04 WS Suppress CD on "merge" so that we can use PR validation builds
# --------------------------------------------------------------------------
- ${{ if and(ne(parameters.suppressCD, true), ne(lower(variables['Build.SourceBranchName']), 'merge')) }}:
  - template: /blueprints/__101__/azure-pipeline-__101__-cd.yml@CeBlueprints
    parameters:
      stage:
        # TODO pass your configuration variables here
        development:
          config:
            active:                       ${{variables.developmentStageActive}}
            envName:                      ${{variables.developmentStageEnvName}}
            namePool:                     ${{coalesce(variables.developmentStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.developmentStageVmImage, 'ubuntu-latest')}}
            testData:                     ${{variables.developmentStageTestData}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        # TODO pass your configuration variables here
        systemTest:
          config:
            active:                       ${{variables.systemTestStageActive}}
            envName:                      ${{variables.systemTestStageEnvName}}
            namePool:                     ${{coalesce(variables.systemTestStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.systemTestStageVmImage, 'ubuntu-latest')}}
            testData:                     ${{variables.systemTestStageTestData}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        # TODO pass your configuration variables here
        staging:
          config:
            active:                       ${{variables.stagingStageActive}}
            envName:                      ${{variables.stagingStageEnvName}}
            namePool:                     ${{coalesce(variables.stagingStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.stagingStageVmImage, 'ubuntu-latest')}}
            testData:                     ${{variables.stagingStageTestData}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        # TODO pass your configuration variables here
        production:
          config:
            active:                       ${{variables.productionStageActive}}
            envName:                      ${{variables.productionStageEnvName}}
            namePool:                     ${{coalesce(variables.productionStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.productionStageVmImage, 'ubuntu-latest')}}
            testData:                     ${{variables.productionStageTestData}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        # TODO pass your configuration variables here
        productionCanadaCentral:
          config:
            active:                       ${{variables.productionCanadaCentralStageActive}}
            envName:                      ${{variables.productionCanadaCentralStageEnvName}}
            namePool:                     ${{coalesce(variables.productionCanadaCentralStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.productionCanadaCentralStageVmImage, 'ubuntu-latest')}}
            testData:                     ${{variables.productionCanadaCentralStageTestData}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        # TODO pass your configuration variables here
        productionCanadaEast:
          config:
            active:                       ${{variables.productionCanadaEastStageActive}}
            envName:                      ${{variables.productionCanadaEastStageEnvName}}
            namePool:                     ${{coalesce(variables.productionCanadaEastStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.productionCanadaEastStageVmImage, 'ubuntu-latest')}}
            testData:                     ${{variables.productionCanadaEastStageTestData}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}

        # Embedded non-negotiable stages ------------------------------------
        securityReview:
          config:
            envName:                      ${{variables.securityReviewStageEnvName}}
            namePool:                     ${{coalesce(variables.securityReviewStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.securityReviewStageVmImage, 'ubuntu-latest')}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        securityAutomation:
          config:
            namePool:                     ${{coalesce(variables.securityAutomationStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.securityAutomationStageVmImage, 'ubuntu-latest')}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        qaAutomation:
          config:
            namePool:                     ${{coalesce(variables.qaAutomationStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.qaAutomationStageVmImage, 'ubuntu-latest')}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}
        preProdAutomation:
          config:
            namePool:                     ${{coalesce(variables.preProdAutomationStagePool, 'Azure Pipelines')}}
            nameVM:                       ${{coalesce(variables.preProdAutomationStageVmImage, 'ubuntu-latest')}}
          applicationBlueprint:           ${{parameters.applicationBlueprint}}
          blueprintVersion:               ${{parameters.blueprintVersion}}
          modeElite:                      ${{parameters.modeElite}}

# --------------------------------------------------------------------------
# END OF PIPELINE
# --------------------------------------------------------------------------
